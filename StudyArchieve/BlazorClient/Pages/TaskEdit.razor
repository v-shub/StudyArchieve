@page "/task/edit/{TaskId:int}"
@using BlazorClient.Services.Contracts.Task
@using BlazorClient.Services.Contracts.Subject
@using BlazorClient.Services.Contracts.AcademicYear
@using BlazorClient.Services.Contracts.TaskType
@using BlazorClient.Services.Contracts.Author
@using BlazorClient.Services.Contracts.Tag
@inject ApiService ApiService
@inject NavigationManager Navigation
@inject ILogger<TaskEdit> Logger

<PageTitle>Редактирование задания - Архив</PageTitle>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
        <p class="mt-3 text-muted">Загрузка задания...</p>
    </div>
}
else if (task == null)
{
    <div class="text-center py-5">
        <i class="bi bi-exclamation-triangle display-1 text-warning mb-3"></i>
        <h4 class="text-warning">Задание не найдено</h4>
        <p class="text-muted">Запрошенное задание не существует или было удалено</p>
        <a href="/tasks" class="btn btn-primary">
            <i class="bi bi-arrow-left me-2"></i>Вернуться к поиску
        </a>
    </div>
}
else
{
    <div class="container">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Главная</a></li>
                <li class="breadcrumb-item"><a href="/tasks">Поиск заданий</a></li>
                <li class="breadcrumb-item"><a href="/task/@TaskId">@task.Title</a></li>
                <li class="breadcrumb-item active">Редактирование</li>
            </ol>
        </nav>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-pencil-square me-2"></i>
                            Редактирование задания
                        </h4>
                    </div>
                    <div class="card-body">
                        <EditForm Model="editTask" OnValidSubmit="SaveTask">
                            <!-- Основная информация -->
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Название задания:</label>
                                <InputText @bind-Value="editTask.Title" class="form-control" placeholder="Введите название задания" />
                                <ValidationMessage For="@(() => editTask.Title)" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Условие задания:</label>
                                <InputTextArea @bind-Value="editTask.ConditionText" class="form-control" rows="6" placeholder="Введите условие задания..." />
                                <ValidationMessage For="@(() => editTask.ConditionText)" />
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Дисциплина:</label>
                                    <select @bind="editTask.SubjectId" class="form-select">
                                        <option value="">Выберите дисциплину</option>
                                        @foreach (var subject in subjects)
                                        {
                                            <option value="@subject.Id">@subject.Name</option>
                                        }
                                    </select>
                                    <ValidationMessage For="@(() => editTask.SubjectId)" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Тип задания:</label>
                                    <select @bind="editTask.TypeId" class="form-select">
                                        <option value="">Выберите тип</option>
                                        @foreach (var type in taskTypes)
                                        {
                                            <option value="@type.Id">@type.Name</option>
                                        }
                                    </select>
                                    <ValidationMessage For="@(() => editTask.TypeId)" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Учебный год:</label>
                                    <select @bind="editTask.AcademicYearId" class="form-select">
                                        <option value="">Не указан</option>
                                        @foreach (var year in academicYears)
                                        {
                                            <option value="@year.Id">@year.YearLabel</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <!-- Авторы -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Авторы:</label>
                                <div class="border rounded p-3 bg-light">
                                    @if (authors.Any())
                                    {
                                        <div class="row">
                                            @foreach (var author in authors)
                                            {
                                                <div class="col-md-6 col-lg-4 mb-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox"
                                                               id="author-@author.Id"
                                                               checked="@(editTask.AuthorIds.Contains(author.Id))"
                                                               @onchange="@((e) => ToggleAuthor(author.Id, (bool)e.Value))" />
                                                        <label class="form-check-label" for="author-@author.Id">
                                                            @author.Name
                                                        </label>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="text-muted text-center mb-0">Авторы не загружены</p>
                                    }
                                    <div class="mt-2">
                                        <small class="text-muted">Выбрано авторов: @editTask.AuthorIds.Count</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Тэги -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Тэги:</label>
                                <div class="border rounded p-3 bg-light">
                                    @if (tags.Any())
                                    {
                                        <div class="row">
                                            @foreach (var tag in tags)
                                            {
                                                <div class="col-md-6 col-lg-4 mb-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox"
                                                               id="tag-@tag.Id"
                                                               checked="@(editTask.TagIds.Contains(tag.Id))"
                                                               @onchange="@((e) => ToggleTag(tag.Id, (bool)e.Value))" />
                                                        <label class="form-check-label" for="tag-@tag.Id">
                                                            @tag.Name
                                                        </label>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="text-muted text-center mb-0">Тэги не загружены</p>
                                    }
                                    <div class="mt-2">
                                        <small class="text-muted">Выбрано тэгов: @editTask.TagIds.Count</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Кнопки действий -->
                            <div class="d-flex gap-2 mt-4 pt-3 border-top">
                                <button type="submit" class="btn btn-success" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="bi bi-check-lg me-2"></i>Сохранить изменения
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="CancelEdit">
                                    <i class="bi bi-x-lg me-2"></i>Отмена
                                </button>
                                <button type="button" class="btn btn-danger ms-auto" @onclick="ShowDeleteModal">
                                    <i class="bi bi-trash me-1"></i>Удалить задание
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>

                <!-- Предварительный просмотр -->
                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-eye me-2"></i>Предварительный просмотр
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Дисциплина:</strong>
                                <span class="ms-1">@(subjects.FirstOrDefault(s => s.Id == editTask.SubjectId)?.Name ?? "Не выбрана")</span>
                            </div>
                            <div class="col-md-6">
                                <strong>Тип задания:</strong>
                                <span class="ms-1">@(taskTypes.FirstOrDefault(t => t.Id == editTask.TypeId)?.Name ?? "Не выбран")</span>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Учебный год:</strong>
                                <span class="ms-1">@(academicYears.FirstOrDefault(y => y.Id == editTask.AcademicYearId)?.YearLabel ?? "Не указан")</span>
                            </div>
                        </div>

                        @if (editTask.AuthorIds.Any())
                        {
                            <div class="mb-3">
                                <strong>Авторы:</strong>
                                <div class="mt-1">
                                    @foreach (var authorId in editTask.AuthorIds)
                                    {
                                        var author = authors.FirstOrDefault(a => a.Id == authorId);
                                        if (author != null)
                                        {
                                            <span class="badge bg-secondary me-1">@author.Name</span>
                                        }
                                    }
                                </div>
                            </div>
                        }

                        @if (editTask.TagIds.Any())
                        {
                            <div class="mb-3">
                                <strong>Тэги:</strong>
                                <div class="mt-1">
                                    @foreach (var tagId in editTask.TagIds)
                                    {
                                        var tag = tags.FirstOrDefault(t => t.Id == tagId);
                                        if (tag != null)
                                        {
                                            <span class="badge bg-success me-1">@tag.Name</span>
                                        }
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Модальное окно удаления задания -->
@if (showDeleteModal)
{
    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Подтверждение удаления</h5>
                    <button type="button" class="btn-close" @onclick="CloseDeleteModal"></button>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите удалить задание <strong>"@task?.Title"</strong>?</p>
                    <p class="text-danger"><small>Это действие нельзя отменить. Будут удалены все связанные файлы и решения.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDeleteModal">Отмена</button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteTask" disabled="@isDeleting">
                        @if (isDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Удалить
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .form-check-input:checked {
        background-color: #198754;
        border-color: #198754;
    }

    .card {
        border: 1px solid #e9ecef;
    }

    .badge {
        font-size: 0.75em;
    }

    .border-top {
        border-top: 2px solid #e9ecef !important;
    }

    .form-select:focus, .form-control:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
</style>

@code {
    [Parameter]
    public int TaskId { get; set; }

    private GetTaskResponse? task;
    private UpdateTaskRequest editTask = new();
    private List<GetSubjectResponse> subjects = new();
    private List<GetAcademicYearResponse> academicYears = new();
    private List<GetTaskTypeResponse> taskTypes = new();
    private List<GetAuthorResponse> authors = new();
    private List<GetTagResponse> tags = new();

    private bool isLoading = true;
    private bool isSaving = false;
    private bool isDeleting = false;
    private bool showDeleteModal = false;

    protected override async Task OnParametersSetAsync()
    {
        if (TaskId > 0)
        {
            await LoadFilterData(); // Сначала загружаем данные для фильтров
            await LoadTask();       // Затем загружаем задание
        }
    }

    private async Task LoadTask()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            task = await ApiService.GetFromJsonAsync<GetTaskResponse>($"api/Task/{TaskId}");

            if (task != null)
            {
                editTask = new UpdateTaskRequest
                {
                    Id = task.Id,
                    Title = task.Title,
                    ConditionText = task.ConditionText ?? "",
                    SubjectId = task.SubjectId,
                    AcademicYearId = task.AcademicYearId,
                    TypeId = task.TypeId,
                    AuthorIds = task.Authors?.Select(a => a.Id).ToList() ?? new List<int>(),
                    TagIds = task.Tags?.Select(t => t.Id).ToList() ?? new List<int>(),
                };
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Ошибка загрузки задания {TaskId}", TaskId);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadFilterData()
    {
        try
        {
            // Загружаем все данные для выпадающих списков и чекбоксов параллельно
            var subjectsTask = ApiService.GetListFromJsonAsync<GetSubjectResponse>("api/Subject");
            var academicYearsTask = ApiService.GetListFromJsonAsync<GetAcademicYearResponse>("api/AcademicYear");
            var taskTypesTask = ApiService.GetListFromJsonAsync<GetTaskTypeResponse>("api/TaskType");
            var authorsTask = ApiService.GetListFromJsonAsync<GetAuthorResponse>("api/Author");
            var tagsTask = ApiService.GetListFromJsonAsync<GetTagResponse>("api/Tag");

            // Ожидаем завершения всех задач
            await Task.WhenAll(subjectsTask, academicYearsTask, taskTypesTask, authorsTask, tagsTask);

            // Получаем результаты
            subjects = await subjectsTask;
            academicYears = await academicYearsTask;
            taskTypes = await taskTypesTask;
            authors = await authorsTask;
            tags = await tagsTask;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Ошибка загрузки данных для фильтров");

            // Инициализируем пустые списки в случае ошибки
            subjects = new List<GetSubjectResponse>();
            academicYears = new List<GetAcademicYearResponse>();
            taskTypes = new List<GetTaskTypeResponse>();
            authors = new List<GetAuthorResponse>();
            tags = new List<GetTagResponse>();
        }
    }

    private void ToggleAuthor(int authorId, bool isSelected)
    {
        if (isSelected)
        {
            if (!editTask.AuthorIds.Contains(authorId))
            {
                editTask.AuthorIds.Add(authorId);
            }
        }
        else
        {
            editTask.AuthorIds.Remove(authorId);
        }
        StateHasChanged();
    }

    private void ToggleTag(int tagId, bool isSelected)
    {
        if (isSelected)
        {
            if (!editTask.TagIds.Contains(tagId))
            {
                editTask.TagIds.Add(tagId);
            }
        }
        else
        {
            editTask.TagIds.Remove(tagId);
        }
        StateHasChanged();
    }

    private async Task SaveTask()
    {
        if (editTask.SubjectId == 0)
        {
            // TODO: Показать сообщение об ошибке
            return;
        }

        if (editTask.TypeId == 0)
        {
            // TODO: Показать сообщение об ошибке
            return;
        }

        isSaving = true;
        StateHasChanged();

        try
        {
            var response = await ApiService.PutAsJsonAsync("api/Task", editTask);
            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo($"/task/{TaskId}");
            }
            else
            {
                // TODO: Показать сообщение об ошибке
                Logger.LogWarning("Ошибка сохранения задания: {StatusCode}", response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Ошибка сохранения задания {TaskId}", TaskId);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private void CancelEdit()
    {
        Navigation.NavigateTo($"/task/{TaskId}");
    }

    private void ShowDeleteModal()
    {
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
    }

    private async Task DeleteTask()
    {
        isDeleting = true;
        StateHasChanged();

        try
        {
            var response = await ApiService.DeleteAsync($"api/Task/{TaskId}");
            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo("/tasks");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Ошибка удаления задания {TaskId}", TaskId);
        }
        finally
        {
            isDeleting = false;
            StateHasChanged();
        }
    }
}